<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoMais - Auditoria (Client-Side)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        body { font-size: 0.75rem; font-family: 'Inter', sans-serif; background-color: #f0f4f0; color: #1e293b; }
        .container-main { max-width: 98%; margin: 15px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        table.dataTable { table-layout: fixed !important; width: 100% !important; border-collapse: collapse !important; }
        table.dataTable thead th { background: #f1f5f9 !important; color: #334155 !important; font-size: 0.85rem !important; font-weight: 700 !important; border-bottom: 2px solid #cbd5e1 !important; height: 45px; text-align: left !important; }
        table.dataTable tbody td { padding: 8px !important; font-size: 0.75rem; border-bottom: 1px solid #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-card { cursor: pointer; height: 85px; display: flex; flex-direction: column; justify-content: center; transition: all 0.2s; border-left: 4px solid rgba(0,0,0,0.1); }
        .stat-card:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .status-badge { padding: 4px 12px; border-radius: 5px; font-size: 0.75rem; font-weight: 800; display: inline-block; line-height: 1; }
        tfoot { display: table-header-group; }
        .filter-wrapper { display: flex; align-items: center; height: 35px; background: white; border: 1px solid #cbd5e1; border-radius: 4px; overflow: hidden; }
        .excel-input { width: 100%; padding: 4px 10px; font-size: 0.8rem; border: none; outline: none; background: transparent; }
        #img-header { display: none; text-align: center; padding-bottom: 20px; border-bottom: 2px solid #15803d; margin-bottom: 20px; }
        #img-header h1 { color: #15803d; font-size: 38px; font-weight: 900; font-style: italic; margin: 0; line-height: 1; letter-spacing: -2px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container-main">
    <div class="flex justify-between items-center mb-6 border-b border-green-100 pb-4">
        <div>
            <h2 class="font-black text-2xl text-green-700 tracking-tighter italic">PONTOMAIS</h2>
            <p class="text-slate-400 text-[9px] font-bold uppercase tracking-wider">Análise e Auditoria de Registros (Local).</p>
        </div>
        
        <div id="upload-section" class="flex gap-3 items-end">
            <div class="flex flex-col">
                <span class="text-[8px] font-bold text-slate-400 uppercase mb-1">Feriados</span>
                <input type="text" id="cal" placeholder="Selecionar..." class="text-[10px] border p-2 rounded bg-white w-40 shadow-sm cursor-pointer" readonly>
            </div>
            <div class="flex flex-col">
                <span class="text-[8px] font-bold text-slate-400 uppercase mb-1">Arquivo CSV</span>
                <input type="file" id="csv_file" accept=".csv" class="text-[10px] border p-1.5 rounded bg-white">
            </div>
            <button id="processBtn" class="bg-green-600 text-white px-5 py-2 rounded text-[10px] font-bold hover:bg-green-700 transition uppercase">Processar</button>
            <button id="clearBtn" class="bg-slate-900 text-white px-6 py-2 rounded text-[10px] font-bold hover:bg-black transition uppercase hidden">Reiniciar</button>
        </div>
    </div>

    <div id="stats-container" class="grid grid-cols-5 gap-4 mb-6 hidden">
        <div onclick="filtrarTipo('FALTA')" class="stat-card bg-slate-900 text-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-start"><span class="text-[8px] font-bold uppercase opacity-80">Faltas</span><i class="fa fa-user-xmark opacity-20"></i></div>
            <div id="stat-falta" class="text-2xl font-black mt-1">0</div>
        </div>
        <div onclick="filtrarTipo('AJUSTE')" class="stat-card bg-green-700 text-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-start"><span class="text-[8px] font-bold uppercase opacity-80">Ajustes</span><i class="fa fa-user-pen opacity-20"></i></div>
            <div id="stat-ajuste" class="text-2xl font-black mt-1">0</div>
        </div>
        <div onclick="filtrarTipo('INT')" class="stat-card bg-emerald-600 text-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-start"><span class="text-[8px] font-bold uppercase opacity-80">Intervalo Curto</span><i class="fa fa-clock opacity-20"></i></div>
            <div id="stat-curto" class="text-2xl font-black mt-1">0</div>
        </div>
        <div onclick="filtrarTipo('PEND')" class="stat-card bg-teal-700 text-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-start"><span class="text-[8px] font-bold uppercase opacity-80">Pendências</span><i class="fa fa-exclamation-triangle opacity-20"></i></div>
            <div id="stat-pendencia" class="text-2xl font-black mt-1">0</div>
        </div>
        <div onclick="filtrarTipo('DOM')" class="stat-card bg-green-900 text-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-start"><span class="text-[8px] font-bold uppercase opacity-80">Domingos/Feriados</span><i class="fa fa-calendar-day opacity-20"></i></div>
            <div id="stat-domingo" class="text-2xl font-black mt-1">0</div>
        </div>
    </div>

    <div id="table-controls" class="flex justify-between items-center mb-4 hidden">
        <div class="flex gap-2">
            <button id="resetAll" class="bg-slate-800 text-white px-3 py-1 rounded hidden items-center gap-2 text-[10px] font-bold uppercase"><i class="fa fa-filter-circle-xmark"></i> LIMPAR FILTROS</button>
            <button id="exportImage" class="bg-blue-600 text-white px-5 py-2 rounded text-[10px] font-black hover:bg-blue-700 transition flex items-center gap-2 uppercase shadow-lg">
                <i class="fa fa-camera"></i> Gerar e Copiar Imagem
            </button>
        </div>
        <div id="btnContainer"></div>
    </div>

    <div id="capture-area" class="hidden">
        <div id="img-header"><h1>PONTOMAIS</h1><p>Análise e Auditoria de Registros.</p></div>
        <table id="tabelaPro" class="display cell-border compact w-full">
            <thead>
                <tr>
                    <th style="width: 15%">Colaborador</th>
                    <th style="width: 12%">Cargo</th>
                    <th style="width: 10%">Equipe</th>
                    <th style="width: 12%">Data</th>
                    <th style="width: 12%">Ocorrência</th>
                    <th style="width: 39%">Detalhes</th>
                    <th class="hidden">Tag</th>
                </tr>
            </thead>
            <tfoot id="table-filters">
                <tr>
                    <th><div class="filter-wrapper"><i class="fa fa-search px-2 text-slate-400"></i><input type="text" class="excel-input search-input" placeholder="Filtrar..."></div></th>
                    <th><select class="select-flegar" multiple="multiple" style="width: 100%"></select></th>
                    <th><select class="select-flegar" multiple="multiple" style="width: 100%"></select></th>
                    <th><div class="filter-wrapper"><i class="fa fa-calendar px-2 text-slate-400"></i><input type="text" class="excel-input search-input" placeholder="Data..."></div></th>
                    <th><select class="select-flegar" multiple="multiple" style="width: 100%"></select></th>
                    <th><div class="filter-wrapper"><i class="fa fa-info-circle px-2 text-slate-400"></i><input type="text" class="excel-input search-input" placeholder="..."></div></th>
                    <th class="hidden"></th>
                </tr>
            </tfoot>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
$(document).ready(function() {
    let flatp = flatpickr("#cal", { mode: "multiple", dateFormat: "d/m/Y", locale: "pt" });
    let table = null;

    // --- LÓGICA DE PROCESSAMENTO (ANTIGO PHP AGORA EM JS) ---
    $('#processBtn').on('click', function() {
        const file = $('#csv_file')[0].files[0];
        if (!file) return alert("Selecione um arquivo CSV!");

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            processarDados(content);
        };
        reader.readAsText(file, 'ISO-8859-1'); // Mantendo a compatibilidade de encoding
    });

    function processarDados(csvText) {
        const lines = csvText.split(/\r?\n/);
        const feriados = $('#cal').val().split(', ');
        
        // Extrair datas de início e fim da linha 2 (índice 2)
        const dateRegex = /(\d{2}\/\d{2}\/\d{4})/g;
        const periodMatches = lines[2].match(dateRegex);
        const dataInicioStr = periodMatches ? periodMatches[0] : null;
        const dataFimStr = periodMatches ? periodMatches[1] : null;

        let agrupado = {};
        let colaboradores = {};
        let alertas = [];
        let stats = { curto: 0, pendencia: 0, domingo: 0, falta: 0, ajuste: 0 };

        // Processar linhas do CSV (começando na linha 5)
        for (let i = 4; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line) continue;

            let row = line.includes(';') ? line.split(';') : line.split(',');
            if (row.length < 5) continue;

            let nome = row[0].trim();
            let cargo = row[1].trim();
            let equipe = row[2].trim();
            let data = row[3];
            let hora = row[4];
            let ajustado = row[8] ? row[8].trim() : '';
            let quemAjustou = row[10] ? row[10].trim() : '';

            if (!agrupado[nome]) agrupado[nome] = {};
            if (!agrupado[nome][data]) agrupado[nome][data] = [];
            agrupado[nome][data].push(hora);
            colaboradores[nome] = { cargo, equipe };

            if (ajustado === "Sim") {
                alertas.push({ n: nome, c: cargo, e: equipe, d: data, m: 'AJUSTE MANUAL', h: `Por: ${quemAjustou}`, t: 'AJUSTE' });
                stats.ajuste++;
            }
        }

        // Validação de Faltas
        if (dataInicioStr && dataFimStr) {
            let current = parseDate(dataInicioStr);
            let end = parseDate(dataFimStr);
            const diasW = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

            while (current <= end) {
                let diaSemana = diasW[current.getDay()];
                let dataPura = formatDate(current);
                let dataFull = `${diaSemana}, ${dataPura}`;

                if (diaSemana !== 'Dom' && diaSemana !== 'Sáb' && !feriados.includes(dataPura)) {
                    Object.keys(colaboradores).forEach(nome => {
                        if (!agrupado[nome] || !agrupado[nome][dataFull]) {
                            alertas.push({ n: nome, c: colaboradores[nome].cargo, e: colaboradores[nome].equipe, d: dataFull, m: 'FALTA', h: 'Dia útil sem registro', t: 'FALTA' });
                            stats.falta++;
                        }
                    });
                }
                current.setDate(current.getDate() + 1);
            }
        }

        // Validação de Pendências e Intervalos
        Object.keys(agrupado).forEach(nome => {
            const info = colaboradores[nome];
            Object.keys(agrupado[nome]).forEach(data => {
                let horas = agrupado[nome][data].sort();
                let num = horas.length;
                let cargoCaps = info.cargo.toUpperCase();
                let limiteIntervalo = cargoCaps.includes('LEITURISTA') ? 1 : 2;

                if (data.toLowerCase().includes('dom') || feriados.some(f => data.includes(f))) {
                    let label = feriados.some(f => data.includes(f)) ? 'FERIADO' : 'DOMINGO';
                    alertas.push({ n: nome, c: info.cargo, e: info.equipe, d: data, m: label, h: horas.join(' | '), t: 'DOM' });
                    stats.domingo++;
                    return;
                }

                let ehDiaUtil = ['seg', 'ter', 'qua', 'qui', 'sex'].some(d => data.toLowerCase().includes(d));
                let pendencia = false;
                let motivo = "";

                if (num % 2 !== 0) {
                    pendencia = true;
                    motivo = `Batida Ímpar (${num} batidas)`;
                } else if (ehDiaUtil && num === 2) {
                    let diff = (parseTime(horas[1]) - parseTime(horas[0])) / 3600000;
                    if (diff > 6) {
                        pendencia = true;
                        motivo = `Jornada > 6h sem intervalo (${diff.toFixed(2)}h)`;
                    }
                }

                if (pendencia) {
                    alertas.push({ n: nome, c: info.cargo, e: info.equipe, d: data, m: 'PENDÊNCIA', h: `${motivo}: ${horas.join(', ')}`, t: 'PEND' });
                    stats.pendencia++;
                }

                // Intervalo Curto
                for (let j = 0; j < num - 1; j++) {
                    let diff = (parseTime(horas[j+1]) - parseTime(horas[j])) / 3600000;
                    if (diff > 0 && diff < limiteIntervalo) {
                        alertas.push({ n: nome, c: info.cargo, e: info.equipe, d: data, m: 'INT. CURTO', h: `Intervalo de ${Math.round(diff*60)} min (${horas[j]} -> ${horas[j+1]}). Mínimo: ${limiteIntervalo}h`, t: 'INT' });
                        stats.curto++;
                        break;
                    }
                }
            });
        });

        renderizarTabela(alertas, stats);
    }

    // --- FUNÇÕES DE INTERFACE ---
    function renderizarTabela(alertas, stats) {
        // Atualizar Stats
        $('#stat-falta').text(stats.falta);
        $('#stat-ajuste').text(stats.ajuste);
        $('#stat-curto').text(stats.curto);
        $('#stat-pendencia').text(stats.pendencia);
        $('#stat-domingo').text(stats.domingo);

        // Mostrar Containers
        $('#stats-container, #table-controls, #capture-area, #clearBtn').removeClass('hidden');
        $('#processBtn, #csv_file').parent().addClass('hidden');
        $('#processBtn').addClass('hidden');

        // Popular Tabela
        let tbody = $('#tabelaPro tbody').empty();
        alertas.forEach(a => {
            let badgeClass = a.t === 'FALTA' ? 'bg-slate-900 text-white' : 
                             a.t === 'INT' ? 'bg-emerald-100 text-emerald-800' : 
                             a.t === 'AJUSTE' ? 'bg-green-700 text-white' :
                             a.t === 'PEND' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-900';

            tbody.append(`
                <tr>
                    <td class="font-bold text-slate-800 uppercase" title="${a.n}">${a.n}</td>
                    <td class="text-slate-500 uppercase" title="${a.c}">${a.c}</td>
                    <td class="text-slate-500 uppercase" title="${a.e}">${a.e}</td>
                    <td class="text-slate-500">${a.d}</td>
                    <td><span class="status-badge ${badgeClass}">${a.m}</span></td>
                    <td class="text-slate-400 italic font-mono text-[10px]" title="${a.h}">${a.h}</td>
                    <td class="hidden">${a.t}</td>
                </tr>
            `);
        });

        if ($.fn.DataTable.isDataTable('#tabelaPro')) {
            table.destroy();
        }

        table = $('#tabelaPro').DataTable({
            "language": { "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
            "pageLength": 100,
            "dom": 'Brtip',
            "autoWidth": false,
            "buttons": [{
                extend: 'excelHtml5',
                text: '<i class="fa fa-file-excel mr-2"></i> EXCEL',
                className: 'bg-green-700 text-white px-5 py-2 rounded text-[10px] font-black hover:bg-green-800 transition',
                exportOptions: { columns: ':visible' }
            }],
            "initComplete": function () {
                var api = this.api();
                table.buttons().container().appendTo('#btnContainer');
                
                // Filtros de busca simples
                api.columns([0, 3, 5]).every(function () {
                    var column = this;
                    $('.search-input', column.footer()).on('keyup change clear', function () {
                        column.search(this.value).draw();
                        toggleResetBtn();
                    });
                });

                // Filtros Select2
                api.columns([1, 2, 4]).every(function () {
                    var column = this;
                    var select = $('.select-flegar', column.footer()).empty();
                    column.data().unique().sort().each(function (d) {
                        var text = $('<div/>').html(d).text().trim();
                        if(text) select.append(`<option value="${text}">${text}</option>`);
                    });
                    select.select2({ placeholder: "Filtrar...", allowClear: true, closeOnSelect: false })
                    .on('change', function() {
                        var vals = $(this).val();
                        if (vals && vals.length > 0) {
                            var search = vals.map(v => `^${$.fn.dataTable.util.escapeRegex(v)}$`).join('|');
                            column.search(search, true, false).draw();
                        } else { column.search('').draw(); }
                        toggleResetBtn();
                    });
                });
            }
        });
    }

    // --- AUXILIARES ---
    function parseDate(str) {
        const parts = str.split('/');
        return new Date(parts[2], parts[1]-1, parts[0]);
    }
    function formatDate(date) {
        return date.toLocaleDateString('pt-BR');
    }
    function parseTime(t) {
        return new Date(`1970-01-01T${t}:00`);
    }

    $('#clearBtn').on('click', () => location.reload());

    window.filtrarTipo = function(tag) {
        $('#resetAll').trigger('click');
        table.column(6).search(tag).draw();
        toggleResetBtn();
    };

    function toggleResetBtn() {
        let hasFilter = false;
        table.columns().every(function() { if (this.search() !== '') hasFilter = true; });
        if (hasFilter) $('#resetAll').css('display', 'inline-flex'); else $('#resetAll').hide();
    }

    $('#resetAll').on('click', function() {
        $('.search-input').val(''); 
        $('.select-flegar').val(null).trigger('change');
        table.columns().search('').draw(); 
        $(this).hide();
    });

    // Captura de Imagem
    $('#exportImage').on('click', function() {
        const btn = $(this); btn.html('<i class="fa fa-spinner fa-spin"></i> Preparando...').prop('disabled', true);
        $('#img-header').show(); $('#table-filters').hide(); $('.dataTables_info, .dataTables_paginate').hide();
        $('#tabelaPro tbody td').css({'white-space': 'normal', 'text-overflow': 'clip', 'overflow': 'visible'});
        
        html2canvas(document.querySelector("#capture-area"), { scale: 2, useCORS: true }).then(canvas => {
            canvas.toBlob(blob => {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]);
                $('#tabelaPro tbody td').css({'white-space': 'nowrap', 'text-overflow': 'ellipsis', 'overflow': 'hidden'});
                $('#img-header').hide(); $('#table-filters').show(); $('.dataTables_info, .dataTables_paginate').show();
                btn.prop('disabled', false).html('<i class="fa fa-check"></i> Copiado!').addClass('bg-green-600');
                setTimeout(() => { btn.html('<i class="fa fa-camera"></i> Gerar e Copiar Imagem').removeClass('bg-green-600'); }, 3000);
            });
        });
    });
});
</script>
</body>
</html>
